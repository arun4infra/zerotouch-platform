apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: platform-bootstrap
  namespace: argocd
spec:
  generators:
  - clusters:
      selector:
        matchLabels:
          environment: kind
      values:
        environment: kind
        overlay: kind
  - clusters:
      selector:
        matchLabels:
          environment: talos
      values:
        environment: talos
        overlay: talos
  template:
    metadata:
      name: 'platform-bootstrap-{{values.environment}}'
      namespace: argocd
      annotations:
        argocd.argoproj.io/sync-wave: "0"
    spec:
      project: default
      sources:
      - repoURL: https://github.com/arun4infra/zerotouch-platform.git
        targetRevision: main
        path: bootstrap/components
        directory:
          recurse: true
      - repoURL: https://github.com/arun4infra/zerotouch-platform.git
        targetRevision: main
        path: platform/01-foundation/overlays/{{values.overlay}}
      destination:
        server: https://kubernetes.default.svc
        namespace: argocd
      ignoreDifferences:
        - group: argoproj.io
          kind: Application
          jsonPointers:
            - /status
      syncPolicy:
        automated:
          prune: true
          selfHeal: true

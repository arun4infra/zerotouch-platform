name: In-Cluster Integration Tests

# ==============================================================================
# Reusable Workflow for In-Cluster Testing (Filesystem Contract)
# ==============================================================================
# This workflow uses the filesystem contract approach where services declare
# their requirements in ci/config.yaml and the platform handles execution.
#
# Usage in other workflows:
#   jobs:
#     integration-tests:
#       uses: ./.github/workflows/in-cluster-test.yml
# ==============================================================================

on:
  workflow_call:
    secrets:
      BOT_GITHUB_TOKEN:
        required: false
      BOT_GITHUB_USERNAME:
        required: false
      AWS_ROLE_ARN:
        required: false

permissions:
  id-token: write      # Required for AWS OIDC authentication
  contents: read
  pull-requests: write

jobs:
  in-cluster-tests:
    name: In-Cluster Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.BOT_GITHUB_TOKEN || github.token }}
      
      - name: Checkout zerotouch-platform
        uses: actions/checkout@v4
        with:
          repository: 'arun4infra/zerotouch-platform'
          path: 'zerotouch-platform'
          token: ${{ secrets.BOT_GITHUB_TOKEN || github.token }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1
          mask-aws-account-id: true
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Setup Platform Environment
        run: |
          # Load service config to get service name and image tag
          SERVICE_NAME=$(yq eval '.service.name' ci/config.yaml 2>/dev/null || echo "unknown-service")
          IMAGE_TAG=$(yq eval '.build.tag // "ci-test"' ci/config.yaml 2>/dev/null)
          
          # Use centralized platform setup orchestrator
          chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/setup-platform-environment.sh
          zerotouch-platform/scripts/bootstrap/preview/tenants/setup-platform-environment.sh --service="$SERVICE_NAME" --image-tag="$IMAGE_TAG"
      
      - name: Bootstrap platform
        env:
          BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
          BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
        run: |
          # Bootstrap the platform using the master bootstrap script
          cd zerotouch-platform
          chmod +x scripts/bootstrap/01-master-bootstrap.sh
          ./scripts/bootstrap/01-master-bootstrap.sh --mode preview
      
      - name: Apply preview patches
        run: |
          # Apply preview environment patches including conditional services
          cd zerotouch-platform
          chmod +x scripts/bootstrap/preview/patches/00-apply-all-patches.sh
          ./scripts/bootstrap/preview/patches/00-apply-all-patches.sh --force
      
      - name: Stage 1 - Platform Readiness
        run: |
          # Validate platform components service needs exist
          chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/check-platform-readiness.sh
          zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/check-platform-readiness.sh
      
      - name: Stage 2 - External Dependencies
        run: |
          # Deploy other services this service depends on
          chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/setup-external-dependencies.sh
          zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/setup-external-dependencies.sh
      
      - name: Pre-deploy diagnostics
        run: |
          # Validate external dependencies
          chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/pre-deploy-diagnostics.sh
          zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/pre-deploy-diagnostics.sh
      
      - name: Stage 3 - Service Deployment
        run: |
          # Deploy the actual service
          chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/deploy.sh
          zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/deploy.sh
      
      - name: Run database migrations
        run: |
          # Run migrations if migrations/ directory exists
          if [[ -d "migrations" ]]; then
            NAMESPACE=$(yq eval '.service.namespace' ci/config.yaml 2>/dev/null || echo "default")
            chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/run-migrations.sh
            zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/run-migrations.sh "$NAMESPACE"
          else
            echo "No migrations/ directory found, skipping database migrations"
          fi
      
      - name: Stage 4 - Internal Validation
        run: |
          # Test service's own infrastructure and health
          chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/post-deploy-diagnostics.sh
          zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/post-deploy-diagnostics.sh
      
      - name: Run in-cluster tests
        run: |
          # Execute integration tests if tests/integration exists
          if [[ -d "tests/integration" ]]; then
            # Load test config from ci/config.yaml
            TEST_PATH="tests/integration"
            TEST_NAME="integration-tests"
            TIMEOUT=$(yq eval '.test.timeout // 600' ci/config.yaml 2>/dev/null)
            NAMESPACE=$(yq eval '.service.namespace' ci/config.yaml 2>/dev/null || echo "default")
            IMAGE_TAG=$(yq eval '.build.tag // "ci-test"' ci/config.yaml 2>/dev/null)
            
            chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/run-test-job.sh
            zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/run-test-job.sh "$TEST_PATH" "$TEST_NAME" "$TIMEOUT" "$NAMESPACE" "$IMAGE_TAG"
          else
            echo "No tests/integration directory found, skipping in-cluster tests"
          fi
      
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const serviceName = require('js-yaml').load(require('fs').readFileSync('ci/config.yaml', 'utf8')).service.name || 'unknown-service';
            
            const body = `## âœ… In-Cluster Integration Tests Completed
            
            **Service:** \`${serviceName}\`
            **Infrastructure:** In-Cluster Kubernetes (Kind + ArgoCD)
            **Approach:** Filesystem Contract (ci/config.yaml)
            
            ### CI Workflow Stages Completed:
            1. âœ… **Platform Readiness** - Validated platform components
            2. âœ… **External Dependencies** - Deployed dependent services  
            3. âœ… **Service Deployment** - Deployed service and ran migrations
            4. âœ… **Internal Validation** - Tested service infrastructure and health
            
            ðŸŽ‰ All stages completed successfully! Check the workflow logs for detailed results.
            
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Cleanup
        if: always()
        run: |
          # Load config for cleanup
          NAMESPACE=$(yq eval '.service.namespace' ci/config.yaml 2>/dev/null || echo "default")
          TEST_NAME="integration-tests"
          
          # Get logs from failed pods for debugging
          if kubectl get pods -n "$NAMESPACE" -l test-suite="$TEST_NAME" --field-selector=status.phase=Failed -o name 2>/dev/null | grep -q .; then
            echo "=== Failed Pod Logs ==="
            kubectl get pods -n "$NAMESPACE" -l test-suite="$TEST_NAME" --field-selector=status.phase=Failed -o name | while read pod; do
              echo "--- Logs for $pod ---"
              kubectl logs "$pod" -n "$NAMESPACE" || true
            done
          fi
          
          # Clean up test jobs
          kubectl delete jobs -n "$NAMESPACE" -l test-suite="$TEST_NAME" --ignore-not-found=true || true
          
          # Clean up the Kind cluster
          kind delete cluster --name zerotouch-preview || true
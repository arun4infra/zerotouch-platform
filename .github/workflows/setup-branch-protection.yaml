name: Setup Branch Protection

# This workflow sets up branch protection rules for main branch
# Run it manually once after initial setup

on:
  workflow_dispatch:
    inputs:
      require_reviews:
        description: 'Require PR reviews (0 or 1)'
        required: false
        default: '1'
        type: choice
        options:
          - '0'
          - '1'

jobs:
  setup-protection:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Enable automatic branch deletion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log('Enabling automatic branch deletion after PR merge...');
            
            await github.rest.repos.update({
              owner,
              repo,
              delete_branch_on_merge: true
            });
            
            console.log('✅ Automatic branch deletion enabled!');

      - name: Setup branch protection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            
            console.log(`Setting up branch protection for ${owner}/${repo}:${branch}`);
            
            try {
              await github.rest.repos.updateBranchProtection({
                owner,
                repo,
                branch,
                required_status_checks: {
                  strict: true,
                  contexts: [
                    'integration-test'
                  ]
                },
                enforce_admins: true,
                required_pull_request_reviews: {
                  required_approving_review_count: parseInt('${{ inputs.require_reviews }}'),
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false
                },
                restrictions: null,
                required_linear_history: true,
                allow_force_pushes: false,
                allow_deletions: false
              });
              
              console.log('✅ Branch protection configured successfully!');
              console.log('');
              console.log('Required status check:');
              console.log('  - integration-test (full platform bootstrap test)');
              console.log('');
              console.log('PRs to main now require this comprehensive test to pass before merging.');
              
            } catch (error) {
              console.error('❌ Failed to set up branch protection:', error.message);
              console.log('');
              console.log('This might happen if:');
              console.log('  1. You need admin permissions on the repo');
              console.log('  2. The repo is a fork (branch protection not available)');
              console.log('  3. BOT_GITHUB_TOKEN lacks required permissions');
              console.log('');
              console.log('Try setting it up manually via GitHub UI instead.');
              console.log('Go to: Settings → Branches → Add rule → Require status check: integration-test');
              throw error;
            }

      - name: Verify setup
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            
            const protection = await github.rest.repos.getBranchProtection({
              owner,
              repo,
              branch
            });
            
            console.log('Current branch protection settings:');
            console.log(JSON.stringify(protection.data, null, 2));

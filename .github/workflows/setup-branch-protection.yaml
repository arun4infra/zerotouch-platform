name: Setup Branch Protection

# This workflow sets up branch protection rules for main branch
# Run it manually once after initial setup

on:
  workflow_dispatch:
    inputs:
      require_reviews:
        description: 'Require PR reviews (0 or 1)'
        required: false
        default: '0'
        type: choice
        options:
          - '0'
          - '1'

jobs:
  setup-protection:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Setup branch protection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            
            console.log(`Setting up branch protection for ${owner}/${repo}:${branch}`);
            
            try {
              await github.rest.repos.updateBranchProtection({
                owner,
                repo,
                branch,
                required_status_checks: {
                  strict: true,
                  contexts: [
                    'validate-manifests',
                    'argocd-diff', 
                    'smoke-test'
                  ]
                },
                enforce_admins: false,
                required_pull_request_reviews: {
                  required_approving_review_count: parseInt('${{ inputs.require_reviews }}')
                },
                restrictions: null,
                allow_force_pushes: false,
                allow_deletions: false
              });
              
              console.log('✅ Branch protection configured successfully!');
              console.log('');
              console.log('Required status checks:');
              console.log('  - validate-manifests');
              console.log('  - argocd-diff');
              console.log('  - smoke-test');
              console.log('');
              console.log('PRs to main now require these checks to pass before merging.');
              
            } catch (error) {
              console.error('❌ Failed to set up branch protection:', error.message);
              console.log('');
              console.log('This might happen if:');
              console.log('  1. You need admin permissions on the repo');
              console.log('  2. The repo is a fork (branch protection not available)');
              console.log('  3. GITHUB_TOKEN lacks required permissions');
              console.log('');
              console.log('Try setting it up manually via GitHub UI instead.');
              console.log('See .github/BRANCH_PROTECTION_SETUP.md for instructions.');
              throw error;
            }

      - name: Verify setup
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            
            const protection = await github.rest.repos.getBranchProtection({
              owner,
              repo,
              branch
            });
            
            console.log('Current branch protection settings:');
            console.log(JSON.stringify(protection.data, null, 2));

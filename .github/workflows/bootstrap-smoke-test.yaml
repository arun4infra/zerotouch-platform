name: Bootstrap Smoke Test

on:
  pull_request:
    paths:
      - 'bootstrap/**'
      - 'platform/01-foundation.yaml'
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install k3d (lightweight K8s)
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Create test cluster
        run: |
          k3d cluster create test-cluster --wait
          kubectl cluster-info

      - name: Test ArgoCD installation
        run: |
          echo "::group::ArgoCD Bootstrap Test"
          
          # Install ArgoCD (simulating bootstrap)
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          
          # Wait for ArgoCD to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd
          
          echo "✅ ArgoCD installed successfully"
          echo "::endgroup::"

      - name: Test platform manifests apply
        run: |
          echo "::group::Platform Manifest Test"
          
          # Try to apply platform manifests (dry-run on real cluster)
          for dir in platform/01-foundation platform/03-intelligence platform/05-databases; do
            if [ -d "$dir" ]; then
              echo "Testing $dir..."
              kubectl apply --dry-run=server -f "$dir" || echo "⚠️  Some resources in $dir may need CRDs"
            fi
          done
          
          echo "::endgroup::"

      - name: Cleanup
        if: always()
        run: |
          k3d cluster delete test-cluster

      - name: Summary
        if: success()
        run: |
          echo "✅ Bootstrap smoke test passed!"
          echo ""
          echo "This validates:"
          echo "  - ArgoCD can be installed"
          echo "  - Platform manifests are syntactically correct"
          echo "  - Basic K8s API compatibility"
          echo ""
          echo "⚠️  Note: This does NOT test:"
          echo "  - Talos-specific features"
          echo "  - Cilium CNI behavior"
          echo "  - Crossplane provisioning"
          echo "  - Production cluster compatibility"

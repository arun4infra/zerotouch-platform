name: Platform Integration Test

on:
  pull_request:
    paths:
      - 'platform/**'
      - 'bootstrap/**'
      - 'scripts/**'
  push:
    branches:
      - main
    paths:
      - 'platform/**'
      - 'bootstrap/**'
      - 'scripts/**'
  workflow_dispatch:

permissions:
  id-token: write      # Required for AWS OIDC authentication
  contents: read

jobs:
  integration-test:
    name: Platform Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1
          mask-aws-account-id: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Debug Branch Detection
        run: |
          echo "=== GitHub Actions Environment ==="
          echo "GITHUB_HEAD_REF: $GITHUB_HEAD_REF"
          echo "GITHUB_REF_NAME: $GITHUB_REF_NAME"
          echo "GITHUB_REF: $GITHUB_REF"
          echo "git branch --show-current: $(git branch --show-current || echo 'empty')"
          echo "git symbolic-ref --short HEAD: $(git symbolic-ref --short HEAD 2>/dev/null || echo 'failed')"
          echo ""
          echo "=== Testing Branch Detection Script ==="
          chmod +x scripts/bootstrap/preview/patches/01-patch-urls.sh
          # Test the branch detection logic
          ./scripts/bootstrap/preview/patches/01-patch-urls.sh --force || true

      - name: Bootstrap Platform Preview Environment
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
          BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
        run: |
          chmod +x scripts/bootstrap/01-master-bootstrap.sh
          ./scripts/bootstrap/01-master-bootstrap.sh --mode preview

      - name: Wait for platform applications to sync
        run: |
          chmod +x scripts/bootstrap/wait/wait-for-sync.sh
          ./scripts/bootstrap/wait/wait-for-sync.sh --timeout 600

      - name: Wait for pods to be ready
        run: |
          chmod +x scripts/bootstrap/wait/wait-for-pods.sh
          ./scripts/bootstrap/wait/wait-for-pods.sh --timeout 600

      - name: Run cluster validation
        run: |
          chmod +x scripts/bootstrap/validation/99-validate-cluster.sh
          ./scripts/bootstrap/validation/99-validate-cluster.sh

      - name: Validate port-forwards
        run: |
          chmod +x scripts/bootstrap/validation/validate-port-forwards.sh
          ./scripts/bootstrap/validation/validate-port-forwards.sh --preview-mode --timeout 300

      - name: Show final cluster state
        if: always()
        run: |
          echo ""
          echo "=== Final Cluster State ==="
          echo ""
          echo "ArgoCD Applications:"
          kubectl get applications -n argocd || true
          echo ""
          echo "All Pods:"
          kubectl get pods -A || true
          echo ""
          echo "Nodes:"
          kubectl get nodes || true

      - name: Collect logs on failure
        if: failure()
        run: |
          echo ""
          echo "=== Collecting logs for debugging ==="
          echo ""
          
          echo "ArgoCD Application Controller logs:"
          kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller --tail=100 || true
          echo ""
          
          echo "External Secrets Operator logs:"
          kubectl logs -n external-secrets -l app.kubernetes.io/name=external-secrets --tail=100 || true
          echo ""
          
          echo "Failed pods:"
          kubectl get pods -A --field-selector=status.phase!=Running,status.phase!=Succeeded || true

      - name: Cleanup preview environment
        if: always()
        run: |
          chmod +x scripts/bootstrap/preview/cleanup-preview.sh
          ./scripts/bootstrap/preview/cleanup-preview.sh || true

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║          ✓ Platform Integration Test PASSED                 ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          echo "All validations passed:"
          echo "  ✓ Platform bootstrapped in preview mode"
          echo "  ✓ All applications synced"
          echo "  ✓ All pods healthy"
          echo "  ✓ Cluster validation passed"
          echo ""

# PostgreSQL (CNPG) - Zero-Touch Provisioning

## Overview

PostgreSQL databases are provisioned using CloudNative-PG (CNPG) via Crossplane with **zero-touch credential management**. No SSM, no ExternalSecrets, no manual passwords.

## Quick Start

Create a PostgresInstance claim with `writeConnectionSecretToRef`:

```yaml
apiVersion: database.bizmatters.io/v1alpha1
kind: PostgresInstance
metadata:
  name: my-service-db
  namespace: my-namespace
spec:
  size: medium    # small, medium, large
  version: "16"   # optional, default: "16"
  storageGB: 20   # optional, default: 20
writeConnectionSecretToRef:
  name: my-service-postgres    # You choose this name
  namespace: my-namespace      # Your app namespace
```

That's it! No credentials to manage.

## What Happens Automatically

1. **CNPG Cluster** created with auto-generated password
2. **Database name** auto-derived: `my-service-db` → `my_service_db`
3. **Owner name** auto-derived: `my-service-db` → `my_service_db`
4. **Connection secret** created at `writeConnectionSecretToRef` location

## Connection Secret Format

The secret specified in `writeConnectionSecretToRef` contains:

| Key | Value |
|-----|-------|
| `endpoint` | `{claim-name}-rw.{claim-namespace}.svc.cluster.local` |
| `port` | `5432` |
| `database` | Auto-derived from claim name (hyphens → underscores) |
| `username` | Auto-derived from claim name (hyphens → underscores) |
| `password` | Auto-generated by CNPG |

## Application Usage

Reference the connection secret in your deployment:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-service
  namespace: my-namespace
spec:
  template:
    spec:
      containers:
        - name: app
          env:
            - name: POSTGRES_HOST
              valueFrom:
                secretKeyRef:
                  name: my-service-postgres
                  key: endpoint
            - name: POSTGRES_PORT
              valueFrom:
                secretKeyRef:
                  name: my-service-postgres
                  key: port
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: my-service-postgres
                  key: database
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: my-service-postgres
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: my-service-postgres
                  key: password
```

## Size Options

| Size | Memory (request/limit) | CPU (request/limit) |
|------|------------------------|---------------------|
| small | 256Mi / 1Gi | 250m / 1000m |
| medium | 512Mi / 2Gi | 500m / 2000m |
| large | 1Gi / 4Gi | 1000m / 4000m |

## Zero-Touch Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Zero-Touch Flow                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   1. You create PostgresInstance claim                              │
│      └─ name: my-service-db                                         │
│      └─ writeConnectionSecretToRef: my-service-postgres             │
│                           │                                          │
│                           ▼                                          │
│   2. Crossplane auto-derives names                                  │
│      ├─ database: my_service_db                                     │
│      ├─ owner: my_service_db                                        │
│      └─ cluster: my-service-db                                      │
│                           │                                          │
│                           ▼                                          │
│   3. CNPG auto-generates password                                   │
│      └─ Creates: my-service-db-app secret                           │
│                           │                                          │
│                           ▼                                          │
│   4. Crossplane copies credentials                                   │
│      └─ To: my-namespace/my-service-postgres                        │
│                           │                                          │
│                           ▼                                          │
│   5. Your app reads from secret                                     │
│      └─ secretKeyRef: my-service-postgres                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**No SSM. No ExternalSecrets. No manual passwords.**

## Name Derivation Rules

| Claim Name | Database | Owner | CNPG Secret |
|------------|----------|-------|-------------|
| `agent-executor-db` | `agent_executor_db` | `agent_executor_db` | `agent-executor-db-app` |
| `my-service` | `my_service` | `my_service` | `my-service-app` |

Hyphens (`-`) are converted to underscores (`_`) for PostgreSQL compatibility.

## Complete Example: agent-executor

```yaml
apiVersion: database.bizmatters.io/v1alpha1
kind: PostgresInstance
metadata:
  name: agent-executor-db
  namespace: intelligence-deepagents
spec:
  size: medium
  version: "16"
  storageGB: 20
writeConnectionSecretToRef:
  name: agent-executor-db-conn
  namespace: intelligence-deepagents
```

**Result:**
- Database: `agent_executor_db`
- Owner: `agent_executor_db`
- Password: Auto-generated
- Connection secret: `agent-executor-db-conn` in `intelligence-deepagents`

## Migration from SSM-Based Pattern

If you have existing SSM-based PostgreSQL:

1. **Update claim** - Add `writeConnectionSecretToRef`, remove deprecated fields
2. **Remove ExternalSecret** - Delete `db-credentials-es.yaml`
3. **Update deployment** - Reference new secret name
4. **Delete SSM parameters** - Optional cleanup

⚠️ The cluster will be recreated with new auto-generated credentials.

## Troubleshooting

### Claim stuck in "Creating"
Check if the CNPG cluster is ready:
```bash
kubectl get cluster -n <namespace>
```

### Connection secret not created
Verify the CNPG `-app` secret exists:
```bash
kubectl get secret <claim-name>-app -n <namespace>
```

### Database not accessible
Check the auto-derived names match your connection string:
```bash
kubectl get secret <claim-name>-app -n <namespace> -o yaml
```

# AgentGateway Configuration for Platform Authentication
# Corrected schema structure for agentgateway binary compatibility

binds:
  - port: 3000
    listeners:
      - name: main-listener
        protocol: HTTP
        routes:
          # 1. Login Routes (Passthrough to Identity Service)
          - name: auth
            matches:
              - path: 
                  pathPrefix: "/auth"
            backends:
              - host: "identity-service.platform-identity.svc.cluster.local:3000"

          # 2. API Routes (Protected via Sidecar Authorizer)
          - name: api
            matches:
              - path: 
                  pathPrefix: "/api"
            policies:
              # Step A: Delegate to Identity Service via HTTP extAuthz
              extAuthz:
                # SCHEMA FIX: 'host' is a direct sibling of 'protocol', not nested in 'backend'
                host: "identity-service.platform-identity.svc.cluster.local:3000"
                # [CORRECTION] This must be a sibling of 'protocol', not a child
                includeRequestHeaders: ["Cookie", "Authorization"]
                protocol:
                  http:
                    path: "/internal/validate"
                    # [NOTE] This remains inside http protocol
                    includeResponseHeaders: ["Authorization", "X-Auth-User-Id", "X-Auth-Org-Id"]
              
              # Step B: Strip the session cookie to ensure downstream only sees the JWT
              requestHeaderModifier:
                remove: ["Cookie"]
            
            backends:
              - host: "ide-orchestrator.intelligence-orchestrator.svc.cluster.local:8080"
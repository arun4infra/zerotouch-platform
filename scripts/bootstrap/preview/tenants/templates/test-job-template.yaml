apiVersion: batch/v1
kind: Job
metadata:
  name: "{{JOB_NAME}}"
  namespace: "{{NAMESPACE}}"
  labels:
    app: "{{SERVICE_NAME}}-tests"
    test-type: integration
    test-suite: "{{TEST_NAME}}"
spec:
  template:
    metadata:
      labels:
        app: "{{SERVICE_NAME}}-tests"
        test-type: integration
        test-suite: "{{TEST_NAME}}"
    spec:
      containers:
      - name: test-runner
        image: "{{IMAGE}}"
        workingDir: /app
        env:
        # Database credentials from K8s secrets (dynamic service name)
        - name: TEST_ENV
          value: "integration"
        - name: SERVICE_NAME
          value: "{{SERVICE_NAME}}"
        - name: NAMESPACE
          value: "{{NAMESPACE}}"
        command: 
        - "/bin/sh"
        - "-c"
        - |
          set -e  # Exit on any error
          set -o pipefail  # Exit on pipe failures
          
          echo "=============================================="
          echo "üöÄ Starting in-cluster integration tests"
          echo "=============================================="
          echo "Service: {{SERVICE_NAME}}"
          echo "Test Path: {{TEST_PATH}}"
          echo "Test Name: {{TEST_NAME}}"
          echo "Namespace: {{NAMESPACE}}"
          echo "Timestamp: $(date)"
          echo ""
          
          echo "=== ENVIRONMENT CHECK ==="
          echo "Working directory: $(pwd)"
          echo "Available disk space:"
          df -h /app || echo "Could not check disk space"
          echo ""
          
          echo "=== TEST PATH VALIDATION ==="
          if [ -f "{{TEST_PATH}}" ] || [ -d "{{TEST_PATH}}" ]; then
            echo "‚úÖ Test path exists: {{TEST_PATH}}"
            if [ -d "{{TEST_PATH}}" ]; then
              echo "Test files in directory:"
              find "{{TEST_PATH}}" -name "*test*" | head -10
            fi
          else
            echo "‚ùå Test path does not exist: {{TEST_PATH}}"
            echo "Available files/directories:"
            ls -la . | head -10
            echo "Looking for test files:"
            find . -name "*test*" | head -10
            exit 1
          fi
          echo ""
          
          echo "=== ARTIFACTS DIRECTORY ==="
          mkdir -p artifacts
          if [ -d "artifacts" ] && [ -w "artifacts" ]; then
            echo "‚úÖ Artifacts directory ready: $(pwd)/artifacts"
          else
            echo "‚ùå Cannot create or write to artifacts directory"
            ls -la . | grep artifacts || echo "No artifacts directory found"
            exit 1
          fi
          echo ""
          
          echo "=============================================="
          echo "üß™ Running integration tests..."
          echo "=============================================="
          
          # Generic test execution - services provide their own test runner
          if [ -f "./scripts/ci/run.sh" ]; then
            echo "Using service CI runner: ./scripts/ci/run.sh"
            if ./scripts/ci/run.sh test 2>&1 | tee artifacts/test-output.log; then
              TEST_EXIT_CODE=0
              echo "‚úÖ Tests passed"
            else
              TEST_EXIT_CODE=$?
              echo "‚ùå Tests failed with exit code: $TEST_EXIT_CODE"
            fi
          elif [ -f "./scripts/ci/run-tests.sh" ]; then
            echo "Using service-specific test runner: ./scripts/ci/run-tests.sh"
            if ./scripts/ci/run-tests.sh "{{TEST_PATH}}" 2>&1 | tee artifacts/test-output.log; then
              TEST_EXIT_CODE=0
              echo "‚úÖ Tests passed"
            else
              TEST_EXIT_CODE=$?
              echo "‚ùå Tests failed with exit code: $TEST_EXIT_CODE"
            fi
          elif [ -f "./run.sh" ]; then
            echo "Using service run script for tests: ./run.sh"
            if ./run.sh test 2>&1 | tee artifacts/test-output.log; then
              TEST_EXIT_CODE=0
              echo "‚úÖ Tests passed"
            else
              TEST_EXIT_CODE=$?
              echo "‚ùå Tests failed with exit code: $TEST_EXIT_CODE"
            fi
          else
            echo "‚ùå No test runner found. Expected: ./scripts/ci/run.sh, ./scripts/ci/run-tests.sh, or ./run.sh"
            echo "Available scripts:"
            find . -name "*.sh" -type f | head -10
            exit 1
          fi
          
          echo ""
          echo "=============================================="
          echo "üìä Test Execution Complete"
          echo "=============================================="
          echo "Test exit code: $TEST_EXIT_CODE"
          echo ""
          
          echo "=== ARTIFACTS GENERATED ==="
          if [ -d "artifacts" ]; then
            echo "Artifacts directory contents:"
            ls -la artifacts/ || echo "No artifacts generated"
          else
            echo "‚ùå No artifacts directory found"
          fi
          echo ""
          
          # Exit with test's exit code
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ All tests completed successfully!"
          else
            echo "‚ùå Tests failed with exit code: $TEST_EXIT_CODE"
          fi
          
          echo "=============================================="
          echo "üèÅ Test execution finished"
          echo "=============================================="
          
          exit $TEST_EXIT_CODE
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1.5Gi"
            cpu: "1000m"
        volumeMounts:
        - name: artifacts
          mountPath: /app/artifacts
      volumes:
      - name: artifacts
        emptyDir: {}
      restartPolicy: Never
      serviceAccountName: default
  backoffLimit: 0  # Don't retry failed pods - fail fast
  ttlSecondsAfterFinished: 3600  # Keep job for 1 hour after completion for debugging